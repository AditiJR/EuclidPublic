<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euclid AI Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-black text-white h-screen flex flex-col">

    <div class="relative flex-grow w-full h-full">
        <video id="video" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline></video>
        <div id="video-off-overlay" class="absolute inset-0 w-full h-full bg-black hidden items-center justify-center">
            <p class="text-xl text-gray-400">Video is Off</p>
        </div>

        <header class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/50 to-transparent">
            <h1 class="text-2xl font-bold text-center">Euclid</h1>
            <p id="instruction" class="text-center text-gray-300 mt-1">Say "Hey Euclid, can you help me?"</p>
        </header>

        <div id="response-container" class="absolute top-4 right-4 w-80 max-w-[90vw] bg-black/50 backdrop-blur-md rounded-lg p-4 border border-white/10 shadow-lg transform translate-x-[150%] transition-transform duration-500 ease-in-out">
            <div id="response-content" class="text-sm">
                </div>
        </div>

        <div id="flash" class="absolute inset-0 bg-white opacity-0 pointer-events-none"></div>
    </div>

    <footer class="bg-black/50 p-3 flex justify-center items-center gap-6 border-t border-white/10">
        <button id="video-toggle" title="Toggle Video" class="text-white hover:text-blue-400 transition-colors">
            <svg id="video-on-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.6 11.6L22 7v10l-6.4-4.6Z"/><path d="M2 5h11a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z"/></svg>
            <svg id="video-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M15.6 11.6L22 7v10l-6.4-4.6Z"/><path d="m2 2 20 20"/><path d="M12 18H3a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h.5"/><path d="M15 15.5V13a2 2 0 0 0-2-2H7.5"/></svg>
        </button>
        <div id="status" class="text-sm font-medium text-gray-300 flex items-center gap-2">
            <div id="mic-active-dot" class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span id="status-text">Listening...</span>
        </div>
        <button id="mute-toggle" title="Toggle Mic" class="text-white hover:text-blue-400 transition-colors">
            <svg id="mic-on-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            <svg id="mic-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="m12 2-1.1 1.1a5 5 0 0 0-4.1 7.1L2 15"/><path d="M15.1 3.9a5 5 0 0 1-1.1 7.1L12 13"/><path d="M22 10v2a7 7 0 0 1-12.2 5.9"/><line x1="12" x2="12" y1="19" y2="22"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
        </button>
    </footer>

    <script>
        const video = document.getElementById('video');
        const flash = document.getElementById('flash');
        const responseContainer = document.getElementById('response-container');
        const responseContent = document.getElementById('response-content');
        const instruction = document.getElementById('instruction');
        const statusText = document.getElementById('status-text');
        const micActiveDot = document.getElementById('mic-active-dot');

        const muteToggle = document.getElementById('mute-toggle');
        const micOnIcon = document.getElementById('mic-on-icon');
        const micOffIcon = document.getElementById('mic-off-icon');
        const videoToggle = document.getElementById('video-toggle');
        const videoOnIcon = document.getElementById('video-on-icon');
        const videoOffIcon = document.getElementById('video-off-icon');
        const videoOffOverlay = document.getElementById('video-off-overlay');

        let isMuted = false;
        let isVideoOff = false;
        let stream;
        let responseTimer;
        let audio;

        const problemSteps = [
            {
                displayText: `<strong>Step 1 - Nudge (factoring idea)</strong><br>Try factoring the quadratic. Use the product-sum trick: a * c = 2 * (-3) = -6. Find two numbers that multiply to -6 and add to b = -5.`,
                speechText: `I can surely help with that! Let's try factoring the quadratic. Use the product-sum trick:  a times see equals 2 times negative 3, which equals negative 6. Find two numbers that multiply to negative 6 and add to bee, which equals negative 5.`
            },
            {
                displayText: `<strong>Step 2 - Structure (grouping)</strong><br>Group terms and factor each group's GCF.<br>(2x² - 6x) + (x - 3) = 2x(x - 3) + 1(x - 3).`,
                speechText: `That looks perfect!Next, Group terms and factor each group's greatest common factor. Too ex squared minus 6 ex, plus, ex minus 3, equals 2 ex times the quantity ex minus 3, plus 1 times the quantity ex minus 3. Can you try that?`
            },
            {
                displayText: `<strong>Step 3 - Execute (common binomial)</strong><br>Factor out the common (x - 3).<br>(x - 3)(2x + 1) = 0.`,
                speechText: `Now.. Factor out the common term, ex minus 3. This gives you, the quantity ex minus 3, times the quantity 2 ex plus 1, equals zero.`
            },
            {
                displayText: `<strong>Step 4 - Method name (Zero Product Property)</strong><br>If a product is zero, at least one factor is zero.<br>x - 3 = 0 or 2x + 1 = 0.`,
                speechText: `You got that right! now, If a product is zero, at least one factors is zero. So that means, ex minus 3 equals zero, or, 2 ex plus 1 equals zero.`
            },
            {
                displayText: `<strong>Step 5 - Solve & quick check</strong><br>Solve each simple equation; then sanity-check.<br>x = 3 or x = -1/2.`,
                speechText: `Almost there! Solve each simple equation, then do a sanity-check. Ex equals 3, or, ex equals negative one half.`
            },
            {
                displayText: `<strong>✅ Problem Solved!</strong><br>You've completed all the steps. Great job! Say a trigger word to start over.`,
                speechText: `Problem Solved! You've completed all the steps. Great job!`
            }
        ];

        let currentStep = 0;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        function setupRecognition() {
            if (!SpeechRecognition) {
                instruction.textContent = 'Speech recognition not supported in this browser.';
                return null;
            }
            const rec = new SpeechRecognition();
            rec.continuous = true;
            rec.interimResults = false;
            rec.lang = 'en-US';
            
            rec.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
                console.log('Heard:', transcript);

                const triggerPhrases = [
                    'hey euclid can you help me', 'please help me', 'help',
                    'what do i do next', "what's next", 'whats next', 'go on',
                    'keep going', 'okay next'
                ];

                if (triggerPhrases.some(phrase => transcript.includes(phrase))) {
                    handleTrigger();
                }
            };
            
            rec.onerror = (event) => {
                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    console.error('Speech recognition error:', event.error);
                }
            };

            rec.onend = () => {
                if (!isMuted && !isVideoOff) {
                    try { recognition.start(); } catch (e) { /* ignore */ }
                }
            };
            return rec;
        }

        recognition = setupRecognition();

        async function startCamera() {
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    video.srcObject = stream;
                    video.style.display = 'block';
                    videoOffOverlay.classList.add('hidden');
                    isVideoOff = false;
                    updateVideoIcons();
                    startRecognition();
                }
            } catch (err) {
                console.error("Error accessing camera:", err);
                instruction.textContent = 'Could not access the camera.';
            }
        }

        function stopCamera() {
            if (stream) stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            video.style.display = 'none';
            videoOffOverlay.classList.remove('hidden');
            isVideoOff = true;
            updateVideoIcons();
            stopRecognition();
        }

        function startRecognition() {
            if (recognition && !isMuted && !isVideoOff) {
                try {
                    recognition.start();
                    updateStatus(true);
                } catch(e) { console.warn("Recognition already started."); }
            }
        }

        function stopRecognition() {
            if (recognition) {
                recognition.stop();
                updateStatus(false);
            }
        }
        
        // MODIFIED: This function now accepts an onStartCallback to signal when audio begins.
        async function playAudioResponse(text, onStartCallback) {
            return new Promise(async (resolve, reject) => {
                if (audio && !audio.paused) {
                    audio.pause();
                }
        
                const url = `http://localhost:5001/generate-audio`;
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text })
                    });
        
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audio = new Audio(audioUrl);
                    
                    audio.onplaying = () => {
                        if (onStartCallback) onStartCallback();
                    };
                    audio.onended = () => resolve();
                    audio.onerror = (e) => reject(e);
                    
                    audio.play();
                } catch (error) {
                    console.error("Error playing audio from backend:", error);
                    reject(error);
                }
            });
        }

        function handleTrigger() {
            console.log('Trigger word detected!');
            
            if (responseTimer) clearTimeout(responseTimer);

            flash.style.opacity = '0.7';
            setTimeout(() => { flash.style.opacity = '0'; }, 150);
            
            responseContainer.classList.remove('translate-x-[150%]');
            responseContent.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="animate-spin-slow h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Euclid is thinking...</span>
                </div>`;

            const randomDelay = Math.random() * 2000 + 2500;

            setTimeout(async () => {
                const step = problemSteps[currentStep];
                
                // MODIFIED: This function will be called when audio starts playing.
                const showTalkingStatus = () => {
                    responseContent.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="6" height="6" rx="1"/><path d="M12 15v3"/><path d="M12 9V6"/><path d="M15 12h3"/><path d="M9 12H6"/>
                            </svg>
                            <span>Euclid is talking...</span>
                        </div>`;
                };

                try {
                    // Pass the callback to the audio function.
                    await playAudioResponse(step.speechText, showTalkingStatus);
                    
                    // After audio is done, update the display text.
                    responseContent.innerHTML = `<p>${step.displayText}</p>`;
        
                    if (currentStep >= problemSteps.length - 1) {
                        currentStep = 0;
                    } else {
                        currentStep++;
                    }
        
                    responseTimer = setTimeout(() => {
                        responseContainer.classList.add('translate-x-[150%]');
                    }, 30000);

                } catch (error) {
                    console.error("Failed to play response:", error);
                    responseContent.innerHTML = `<p class="text-red-400">Sorry, there was an error with the response.</p>`;
                }
            }, randomDelay);
        }
        
        function updateStatus(isListening) {
            if(isListening && !isMuted && !isVideoOff) {
                statusText.textContent = "Listening...";
                micActiveDot.className = 'w-2 h-2 bg-green-500 rounded-full';
            } else if (isVideoOff) {
                statusText.textContent = "Video Off";
                micActiveDot.className = 'w-2 h-2 bg-red-500 rounded-full';
            } else if (isMuted) {
                statusText.textContent = "Muted";
                micActiveDot.className = 'w-2 h-2 bg-red-500 rounded-full';
            }
        }

        function updateMuteIcons() {
            micOnIcon.classList.toggle('hidden', isMuted);
            micOffIcon.classList.toggle('hidden', !isMuted);
        }

        function updateVideoIcons() {
            videoOnIcon.classList.toggle('hidden', isVideoOff);
            videoOffIcon.classList.toggle('hidden', !isVideoOff);
        }

        muteToggle.addEventListener('click', () => {
            isMuted = !isMuted;
            updateMuteIcons();
            if (isMuted) stopRecognition();
            else startRecognition();
        });

        videoToggle.addEventListener('click', () => {
            if (isVideoOff) startCamera();
            else stopCamera();
        });

        responseContainer.addEventListener('click', () => {
            if (responseTimer) clearTimeout(responseTimer);
            responseContainer.classList.add('translate-x-[150%]');
        });

        startCamera();
    </script>
</body>
</html>